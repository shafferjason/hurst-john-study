<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson - Hurst Class Study</title>
    <!-- Updated CSS file with all UX enhancements -->
    <link rel="stylesheet" href="style.css?v=68">
</head>
<body>
    <!-- Sticky Breadcrumb Navigation -->
    <nav class="breadcrumb-nav">
        <div class="breadcrumb-container">
            <div class="breadcrumb">
                <a href="index.html">Home</a>
                <span class="separator">›</span>
                <span class="current" id="breadcrumb-title">Lesson</span>
            </div>
            <a href="index.html" class="back-button">
                <span class="back-arrow">←</span>
                <span class="back-text">Back to All Lessons</span>
            </a>
        </div>
    </nav>

    <div class="container">
        <article id="lesson-content">
        </article>

        <nav class="lesson-navigation">
        </nav>
    </div>

    <!-- Back-to-top button will be auto-injected here by JavaScript -->

    <script src="data.js"></script>
    <script>
        // Format content text - convert newlines to paragraphs, handle bullets and headers
        function formatContent(text) {
            if (!text) return '';
            
            // Split by double newlines (paragraphs)
            let paragraphs = text.split(/\n\n+/);
            
            let html = '';
            let inList = false;
            
            paragraphs.forEach(para => {
                para = para.trim();
                if (!para) return;
                
                // Check if this paragraph contains bullet points
                if (para.includes('•')) {
                    // Split by bullet points
                    let lines = para.split(/\n/);
                    let headerText = '';
                    let bullets = [];
                    
                    lines.forEach(line => {
                        line = line.trim();
                        if (line.startsWith('•')) {
                            bullets.push(line.substring(1).trim());
                        } else if (line && bullets.length === 0) {
                            // Text before bullets - treat as header/intro
                            headerText = line;
                        }
                    });
                    
                    if (headerText) {
                        html += '<p class="section-header">' + headerText + '</p>';
                    }
                    
                    if (bullets.length > 0) {
                        html += '<ul class="content-list">';
                        bullets.forEach(bullet => {
                            html += '<li>' + bullet + '</li>';
                        });
                        html += '</ul>';
                    }
                } else {
                    // Check if it looks like a section header (short, no period at end, often followed by content)
                    let isHeader = para.length < 80 && 
                                   !para.endsWith('.') && 
                                   !para.endsWith('?') && 
                                   !para.endsWith('"') &&
                                   (para.includes(':') || /^[A-Z]/.test(para));
                    
                    // More specific header patterns
                    if (para.match(/^(The |A |What |Why |How |Key |[0-9]+\.|Example)/)) {
                        isHeader = para.length < 100 && !para.endsWith('.');
                    }
                    
                    if (isHeader && para.length < 60) {
                        html += '<p class="section-header">' + para + '</p>';
                    } else {
                        html += '<p>' + para + '</p>';
                    }
                }
            });
            
            return html;
        }
        
        // Format tie-in text to style reflective question
        function formatTieIn(text) {
            // Check if there's a reflective question section
            const reflectiveMarker = 'Reflective Question for the Reader';
            if (text.includes(reflectiveMarker)) {
                const parts = text.split(reflectiveMarker);
                const mainContent = parts[0].trim();
                const question = parts[1] ? parts[1].trim() : '';
                
                return formatContent(mainContent) + 
                    '<div class="reflective-question">' +
                    '<span class="reflective-label">Reflective Question</span>' +
                    '<p class="reflective-text">' + question + '</p>' +
                    '</div>';
            }
            return formatContent(text);
        }
        
        // Get the lesson ID from the URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('id');

        // Find the lesson in the data
        const currentLesson = lessonData.find(lesson => lesson.id === lessonId);

        if (!currentLesson) {
            // Lesson not found
            document.getElementById('lesson-content').innerHTML = `
                <div class="error-message">
                    <h1>Lesson Not Found</h1>
                    <p>Sorry, we couldn't find the lesson you're looking for.</p>
                    <a href="index.html" class="button">Return to All Lessons</a>
                </div>
            `;
        } else {
            // Update page title and breadcrumb
            document.title = currentLesson.title + ' - Hurst Class Study';
            document.getElementById('breadcrumb-title').textContent = currentLesson.title;

            // Extract lyrics preview (first 4 lines)
            let lyricsPreview = '';
            if (currentLesson.song_lyrics) {
                const lyricsLines = currentLesson.song_lyrics.split('\n');
                lyricsPreview = lyricsLines.slice(0, 4).join('\n');
            }

            // Build the lesson content
            const lessonContent = document.getElementById('lesson-content');
            
            // Debug: Log the lesson data
            console.log('Current lesson data:', {
                id: currentLesson.id,
                title: currentLesson.title,
                song_title: currentLesson.song_title,
                image_url: currentLesson.image_url,
                audio_file: currentLesson.audio_file,
                has_lyrics: !!currentLesson.song_lyrics
            });
            
            lessonContent.innerHTML = `
                <header class="lesson-header">
                    <h1>${currentLesson.title}</h1>
                    <p class="scripture-reference">${currentLesson.scripture}</p>
                </header>

                <section class="lesson-summary">
                    <h2>Lesson at a Glance</h2>
                    <p class="preview-text">${currentLesson.summary_preview}</p>
                    <details class="accordion">
                        <summary>Read Full Lesson Summary</summary>
                        <div class="accordion-content">
                            ${formatContent(currentLesson.summary_full)}
                        </div>
                    </details>
                    <button class="infographic-btn" id="openInfographic" style="display:none;">
                        <span class="infographic-btn-icon">◈</span>
                        View Lesson Infographic
                    </button>
                </section>

                <!-- Infographic Modal -->
                <div class="infographic-modal" id="infographicModal">
                    <div class="infographic-modal-overlay" id="modalOverlay"></div>
                    <div class="infographic-modal-content">
                        <button class="infographic-modal-close" id="closeInfographic">✕</button>
                        <img src="" alt="Lesson Infographic" class="infographic-modal-image" id="infographicImage">
                    </div>
                </div>

                <!-- Ornate divider for visual section break -->
                <div class="divider-ornate"></div>

                <section class="song-tie-in">
                    <h2>Song Tie-in</h2>
                    <p class="preview-text">${currentLesson.tie_in_preview}</p>
                    <details class="accordion">
                        <summary>Read About the Song</summary>
                        <div class="accordion-content">
                            ${formatTieIn(currentLesson.tie_in_full)}
                        </div>
                    </details>
                </section>

                <!-- Ornate divider before song section -->
                <div class="divider-ornate"></div>

                <section class="song-section">
                    <h2>${currentLesson.song_title}</h2>
                    
                    <!-- The Tenth Hour logo - links to songs page -->
                    <div class="song-attribution">
                        <a href="songs.html?from=${currentLesson.id}" title="View all songs">
                            <img src="logo.svg" alt="The Tenth Hour" class="song-logo">
                        </a>
                    </div>
                    
                    <!-- Grid layout: image left, content right -->
                    <div class="song-content-grid">
                        <!-- Animated Image Container - left column -->
                        <div class="lesson-image-container" id="lessonImageContainer">
                            <!-- Default/fallback image - always present -->
                            <img 
                                src="${currentLesson.image_url || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22280%22 height=%22280%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%23333%22/%3E%3C/svg%3E'}" 
                                alt="${currentLesson.song_title}" 
                                class="song-image lesson-image-default"
                                id="lessonImageDefault">
                            <!-- Animation frames will be added here by JavaScript if they exist -->
                        </div>
                        <!-- Right column: player + lyrics wrapped together -->
                        <div class="song-right-column">
                            ${currentLesson.audio_file ? `
                                <!-- Audio Player -->
                                <div class="simple-audio-player">
                                    <audio id="lesson-audio" src="${currentLesson.audio_file}"></audio>
                                    
                                    <!-- Speaker icon in upper right -->
                                    <div class="audio-speaker-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                        </svg>
                                    </div>
                                    
                                    <div class="simple-player-controls">
                                        <button id="play-pause-btn" class="simple-player-btn" aria-label="Play/Pause">
                                            <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"/>
                                            </svg>
                                            <svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;">
                                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                            </svg>
                                        </button>
                                        
                                        <div class="simple-progress-wrapper">
                                            <div id="current-time" class="simple-time-display">0:00</div>
                                            <input type="range" id="seek-bar" class="simple-seek-bar" value="0" min="0" max="100" aria-label="Audio seek bar">
                                            <div id="duration" class="simple-time-display">0:00</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${currentLesson.song_lyrics ? `
                                <!-- Lyrics -->
                                <details class="accordion lyrics-accordion">
                                    <summary>View Song Lyrics</summary>
                                    <div class="accordion-content">
                                        <div class="lyrics-text">${currentLesson.song_lyrics}</div>
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Suno link - centered below grid -->
                    ${currentLesson.suno_link ? `
                        <p class="suno-link">
                            Can't play? <a href="${currentLesson.suno_link}" target="_blank" rel="noopener noreferrer">Listen on Suno →</a>
                        </p>
                    ` : ''}
                </section>
            `;

            // Build navigation links
            const currentIndex = lessonData.findIndex(lesson => lesson.id === lessonId);
            const navSection = document.querySelector('.lesson-navigation');
            
            let navHTML = '<div class="nav-links">';
            
            // Previous lesson link
            if (currentIndex > 0) {
                const prevLesson = lessonData[currentIndex - 1];
                navHTML += `
                    <a href="lesson.html?id=${prevLesson.id}" class="nav-link prev-link" title="${prevLesson.title}">
                        <span class="nav-arrow">←</span>
                        <span class="nav-label">Previous</span>
                    </a>
                `;
            } else {
                navHTML += '<span class="nav-link-placeholder"></span>';
            }
            
            // Next lesson link
            if (currentIndex < lessonData.length - 1) {
                const nextLesson = lessonData[currentIndex + 1];
                navHTML += `
                    <a href="lesson.html?id=${nextLesson.id}" class="nav-link next-link" title="${nextLesson.title}">
                        <span class="nav-label">Next</span>
                        <span class="nav-arrow">→</span>
                    </a>
                `;
            } else {
                navHTML += '<span class="nav-link-placeholder"></span>';
            }
            
            navHTML += '</div>';
            navSection.innerHTML = navHTML;

            // === AUDIO PLAYER JAVASCRIPT ===
            // This code must run *after* the innerHTML is set
            if (currentLesson.audio_file) {
                const audio = document.getElementById('lesson-audio');
                const playPauseBtn = document.getElementById('play-pause-btn');
                const playIcon = playPauseBtn.querySelector('.play-icon');
                const pauseIcon = playPauseBtn.querySelector('.pause-icon');
                const seekBar = document.getElementById('seek-bar');
                const currentTimeEl = document.getElementById('current-time');
                const durationEl = document.getElementById('duration');
                const audioPlayer = document.querySelector('.simple-audio-player');

                // Helper function to format time in 0:00
                function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                }

                // Play/Pause functionality
                playPauseBtn.addEventListener('click', () => {
                    if (audio.paused) {
                        audio.play();
                        playIcon.style.display = 'none';
                        pauseIcon.style.display = 'inline-block';
                        audioPlayer.classList.add('playing'); // Add fire effect
                    } else {
                        audio.pause();
                        playIcon.style.display = 'inline-block';
                        pauseIcon.style.display = 'none';
                        audioPlayer.classList.remove('playing'); // Remove fire effect
                    }
                });

                // Update seek bar and time as audio plays
                audio.addEventListener('timeupdate', () => {
                    seekBar.value = audio.currentTime; 
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                });

                // Set total duration when audio loads
                audio.addEventListener('loadedmetadata', () => {
                    durationEl.textContent = formatTime(audio.duration);
                    seekBar.max = audio.duration; 
                    
                    // Set up Media Session API for lock screen/control center display
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: currentLesson.song_title,
                            artist: 'The Tenth Hour',
                            album: 'Hurst Class Study: Book of John',
                            artwork: [
                                { src: currentLesson.image_url, sizes: '512x512', type: 'image/jpeg' }
                            ]
                        });
                        
                        // Set up action handlers for media controls
                        navigator.mediaSession.setActionHandler('play', () => {
                            audio.play();
                            playIcon.style.display = 'none';
                            pauseIcon.style.display = 'inline-block';
                            audioPlayer.classList.add('playing');
                        });
                        
                        navigator.mediaSession.setActionHandler('pause', () => {
                            audio.pause();
                            playIcon.style.display = 'inline-block';
                            pauseIcon.style.display = 'none';
                            audioPlayer.classList.remove('playing');
                        });
                        
                        navigator.mediaSession.setActionHandler('seekbackward', () => {
                            audio.currentTime = Math.max(audio.currentTime - 10, 0);
                        });
                        
                        navigator.mediaSession.setActionHandler('seekforward', () => {
                            audio.currentTime = Math.min(audio.currentTime + 10, audio.duration);
                        });
                        
                        navigator.mediaSession.setActionHandler('seekto', (details) => {
                            if (details.seekTime) {
                                audio.currentTime = details.seekTime;
                            }
                        });
                    }
                });
                
                // Allow user to seek by dragging the bar
                seekBar.addEventListener('input', () => {
                    audio.currentTime = seekBar.value;
                });
                
                // Reset player when audio ends
                audio.addEventListener('ended', () => {
                    playIcon.style.display = 'inline-block';
                    pauseIcon.style.display = 'none';
                    seekBar.value = 0;
                    currentTimeEl.textContent = '0:00';
                    audioPlayer.classList.remove('playing'); // Remove fire effect
                });
            }
            // === END AUDIO PLAYER JAVASCRIPT ===

            // === IMAGE ANIMATION JAVASCRIPT ===
            // Check if animation images exist and set up animation if they do
            // lessonId is already defined from URL params at the top
            const imageContainer = document.getElementById('lessonImageContainer');
            const imageDefault = document.getElementById('lessonImageDefault');
            
            console.log('Checking for animation images for lesson:', lessonId);
            
            // Try to load animation frames from images folder
            const frame1Path = `images/${lessonId}-img1.png`;
            const frame2Path = `images/${lessonId}-img2.png`;
            const frame3Path = `images/${lessonId}-img3.png`;
            
            let animationFramesAvailable = false;
            let loadedFrames = 0;
            const requiredFrames = 3;
            let imageFrame1, imageFrame2, imageFrame3;
            
            // Test if images exist by trying to load them
            function checkImageExists(path, callback) {
                const img = new Image();
                img.onload = () => {
                    console.log('✓ Image found:', path);
                    callback(true);
                };
                img.onerror = () => {
                    console.log('✗ Image not found:', path);
                    callback(false);
                };
                img.src = path;
            }
            
            // Check all 3 frames
            checkImageExists(frame1Path, (exists1) => {
                if (exists1) {
                    // Create img element only if file exists
                    imageFrame1 = document.createElement('img');
                    imageFrame1.src = frame1Path;
                    imageFrame1.className = 'song-image lesson-image-layer';
                    imageFrame1.setAttribute('data-frame', '1');
                    imageFrame1.style.display = 'none';
                    imageContainer.appendChild(imageFrame1);
                    loadedFrames++;
                }
                
                checkImageExists(frame2Path, (exists2) => {
                    if (exists2) {
                        imageFrame2 = document.createElement('img');
                        imageFrame2.src = frame2Path;
                        imageFrame2.className = 'song-image lesson-image-layer';
                        imageFrame2.setAttribute('data-frame', '2');
                        imageFrame2.style.display = 'none';
                        imageContainer.appendChild(imageFrame2);
                        loadedFrames++;
                    }
                    
                    checkImageExists(frame3Path, (exists3) => {
                        if (exists3) {
                            imageFrame3 = document.createElement('img');
                            imageFrame3.src = frame3Path;
                            imageFrame3.className = 'song-image lesson-image-layer';
                            imageFrame3.setAttribute('data-frame', '3');
                            imageFrame3.style.display = 'none';
                            imageContainer.appendChild(imageFrame3);
                            loadedFrames++;
                        }
                        
                        // If all 3 frames loaded successfully, enable animation
                        console.log('Loaded frames:', loadedFrames, '/ Required:', requiredFrames);
                        if (loadedFrames === requiredFrames) {
                            animationFramesAvailable = true;
                            console.log('✓ Animation enabled for lesson', lessonId);
                            setupImageAnimation();
                        } else {
                            console.log('✗ Animation disabled - not all frames found');
                        }
                    });
                });
            });
            
            // Set up animation if frames are available
            function setupImageAnimation() {
                console.log('setupImageAnimation called');
                console.log('animationFramesAvailable:', animationFramesAvailable);
                console.log('currentLesson.audio_file:', currentLesson.audio_file);
                
                if (!animationFramesAvailable || !currentLesson.audio_file) {
                    console.log('Animation setup aborted - frames or audio missing');
                    return;
                }
                
                console.log('Setting up animation...');
                const audio = document.getElementById('lesson-audio');
                const loopPattern = [1, 2, 3, 2]; // Pattern: 1→2→3→2→1→2→3→2...
                let currentPatternIndex = 0;
                let animationInterval = null;
                
                const transitionSpeed = 10; // 10 seconds
                const cycleInterval = 10000; // 10 seconds in milliseconds
                
                // Set transition duration on all layers
                imageFrame1.style.transition = `opacity ${transitionSpeed}s ease-in-out`;
                imageFrame2.style.transition = `opacity ${transitionSpeed}s ease-in-out`;
                imageFrame3.style.transition = `opacity ${transitionSpeed}s ease-in-out`;
                
                function showFrame(frameNumber) {
                    console.log('Showing frame:', frameNumber);
                    // Hide default image
                    imageDefault.style.opacity = '0';
                    
                    // Show all frames (they're stacked)
                    imageFrame1.style.display = 'block';
                    imageFrame2.style.display = 'block';
                    imageFrame3.style.display = 'block';
                    
                    // Set opacity based on active frame
                    imageFrame1.style.opacity = frameNumber === 1 ? '1' : '0';
                    imageFrame2.style.opacity = frameNumber === 2 ? '1' : '0';
                    imageFrame3.style.opacity = frameNumber === 3 ? '1' : '0';
                }
                
                function advanceAnimation() {
                    currentPatternIndex = (currentPatternIndex + 1) % loopPattern.length;
                    const frameNumber = loopPattern[currentPatternIndex];
                    console.log('Advancing to frame:', frameNumber);
                    showFrame(frameNumber);
                }
                
                function startAnimation() {
                    console.log('startAnimation called');
                    if (animationInterval) {
                        console.log('Animation already running');
                        return;
                    }
                    
                    console.log('Starting animation - showing first frame');
                    // Start with frame 1
                    showFrame(loopPattern[0]);
                    
                    // Begin cycling
                    console.log('Setting interval for', cycleInterval, 'ms');
                    animationInterval = setInterval(advanceAnimation, cycleInterval);
                }
                
                function stopAnimation() {
                    if (animationInterval) {
                        clearInterval(animationInterval);
                        animationInterval = null;
                    }
                }
                
                function resetAnimation() {
                    stopAnimation();
                    currentPatternIndex = 0;
                    
                    // Hide animation frames, show default
                    imageFrame1.style.display = 'none';
                    imageFrame2.style.display = 'none';
                    imageFrame3.style.display = 'none';
                    imageDefault.style.opacity = '1';
                }
                
                // Connect animation to audio playback
                console.log('Attaching audio event listeners to:', audio);
                audio.addEventListener('play', () => {
                    console.log('Audio PLAY event fired');
                    startAnimation();
                });
                audio.addEventListener('pause', () => {
                    console.log('Audio PAUSE event fired');
                    stopAnimation();
                });
                audio.addEventListener('ended', () => {
                    console.log('Audio ENDED event fired');
                    resetAnimation();
                });
                console.log('Animation setup complete!');
            }
            // === END IMAGE ANIMATION JAVASCRIPT ===

            // === INFOGRAPHIC MODAL JAVASCRIPT ===
            const infographicPath = `images/${lessonId}-infographic.png`;
            const infographicBtn = document.getElementById('openInfographic');
            const infographicModal = document.getElementById('infographicModal');
            const infographicImage = document.getElementById('infographicImage');
            const closeInfographic = document.getElementById('closeInfographic');
            const modalOverlay = document.getElementById('modalOverlay');

            // Check if infographic exists
            const testInfographic = new Image();
            testInfographic.onload = () => {
                console.log('✓ Infographic found:', infographicPath);
                infographicBtn.style.display = 'flex';
                infographicImage.src = infographicPath;
            };
            testInfographic.onerror = () => {
                console.log('✗ No infographic for this lesson');
            };
            testInfographic.src = infographicPath;

            // Open modal
            infographicBtn.addEventListener('click', () => {
                infographicModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });

            // Close modal functions
            function closeModal() {
                infographicModal.classList.remove('active');
                document.body.style.overflow = '';
            }

            closeInfographic.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && infographicModal.classList.contains('active')) {
                    closeModal();
                }
            });
            // === END INFOGRAPHIC MODAL JAVASCRIPT ===
        }
        
        
        // === SCROLL FADE-IN DISABLED ===
        // Sections now appear immediately without fade animation
        document.querySelectorAll('.lesson-summary, .song-tie-in, .song-lyrics-section, .song-section').forEach(section => {
            section.classList.add('illuminate');
        });
        
        // Header is always visible immediately
        const header = document.querySelector('.lesson-header');
        if (header) {
            header.classList.add('illuminate');
        }
        // === END SCROLL FADE-IN ===
        
        // === ACCORDION ANIMATION REPLAY ===
        // Force animations to replay every time accordion opens + smooth closing
        document.querySelectorAll('.accordion').forEach(accordion => {
            accordion.addEventListener('toggle', function(e) {
                const content = this.querySelector('.accordion-content');
                
                if (this.open) {
                    // MOBILE ONLY: Auto-close other main accordions (not lyrics accordion)
                    if (window.innerWidth <= 768) {
                        const isMainAccordion = this.closest('.lesson-summary, .song-tie-in') && !this.classList.contains('lyrics-accordion');
                        
                        if (isMainAccordion) {
                            // Scroll to this accordion FIRST to prevent jump
                            this.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            
                            // Find all other main accordions (excluding lyrics)
                            const mainAccordions = document.querySelectorAll('.lesson-summary .accordion, .song-tie-in .accordion:not(.lyrics-accordion)');
                            
                            mainAccordions.forEach(otherAccordion => {
                                if (otherAccordion !== this && otherAccordion.open) {
                                    // Close it smoothly
                                    otherAccordion.setAttribute('closing', '');
                                    setTimeout(() => {
                                        otherAccordion.removeAttribute('open');
                                        otherAccordion.removeAttribute('closing');
                                    }, 1600);
                                }
                            });
                        }
                    }
                    
                    // OPENING: Force animation replay with cascading
                    if (content) {
                        // Remove closing state if present
                        this.removeAttribute('closing');
                        
                        // Remove temporary class (forces browser to recalculate all child animations)
                        content.classList.add('no-animate');
                        
                        // Force reflow
                        void content.offsetWidth;
                        
                        // Remove the class (animations will restart with delays intact)
                        content.classList.remove('no-animate');
                    }
                } else {
                    // CLOSING: Fade out smoothly before actually closing
                    e.preventDefault(); // Prevent immediate close
                    
                    // Add closing state for animation
                    this.setAttribute('closing', '');
                    
                    // Wait for fade out animation, then actually close
                    setTimeout(() => {
                        this.removeAttribute('open');
                        this.removeAttribute('closing');
                    }, 1600); // Match accordionFadeOut duration (1.6s)
                }
            });
        });
        
        // === ADD CLOSE BUTTONS TO ACCORDION CONTENT (MOBILE ONLY) ===
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.lesson-summary .accordion-content, .song-tie-in .accordion-content').forEach(content => {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'accordion-close-btn';
                closeBtn.textContent = 'Close';
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const accordion = this.closest('.accordion');
                    if (accordion && accordion.open) {
                        // Scroll to the accordion's top BEFORE starting close animation
                        accordion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        
                        // Small delay to let scroll start, then begin close animation
                        setTimeout(() => {
                            accordion.setAttribute('closing', '');
                            setTimeout(() => {
                                accordion.removeAttribute('open');
                                accordion.removeAttribute('closing');
                            }, 1600);
                        }, 100);
                    }
                });
                content.appendChild(closeBtn);
            });
        }
        // === END ACCORDION REPLAY ===
        
        // ========================================
        // SWIPE GESTURE NAVIGATION (Mobile Only)
        // ========================================
        (function() {
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            let touchStartedInAccordion = false;
            
            const minSwipeDistance = 80;
            const maxVerticalDistance = 100;
            
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                
                // Check if touch started inside an open accordion
                const target = e.target;
                const openAccordion = target.closest('.accordion[open]');
                touchStartedInAccordion = openAccordion !== null;
            }, { passive: true });
            
            document.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });
            
            function handleSwipe() {
                // Don't trigger swipe navigation if touch was inside an accordion
                if (touchStartedInAccordion) return;
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = Math.abs(touchEndY - touchStartY);
                
                // Only trigger if horizontal swipe is significant and vertical movement is small
                if (Math.abs(deltaX) > minSwipeDistance && deltaY < maxVerticalDistance) {
                    if (deltaX > 0) {
                        // Swiped right → go to previous lesson
                        const prevLink = document.querySelector('.nav-link.prev-link');
                        if (prevLink) {
                            prevLink.click();
                        }
                    } else {
                        // Swiped left → go to next lesson
                        const nextLink = document.querySelector('.nav-link.next-link');
                        if (nextLink) {
                            nextLink.click();
                        }
                    }
                }
            }
        })();
    </script>

</body>
</html>
